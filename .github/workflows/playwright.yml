name: Playwright Tests

on:
  push:
    branches: [main, master, e2e-workout]
  pull_request:
    branches: [main, master, e2e-workout]

jobs:
  test:
    timeout-minutes: 30  # Adjusted timeout from 60 to 30
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: 📂 Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: 📦 Install Dependencies
        run: |
          npm ci
          cd frontend && npm ci
          cd ../backend && npm ci && npm install --save-dev cross-env

      - name: 📄 Create .env file for Backend
        run: |
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" > backend/.env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> backend/.env
          echo "NODE_ENV=production" >> backend/.env

      - name: 🔄 Seed Database (If Required)
        working-directory: backend
        run: |
          if [ -f src/db/seed.js ]; then
            node src/db/seed.js || (echo "❌ Database seeding failed!" && exit 1)
          else
            echo "⚠️ No seed file found, skipping..."
          fi

      - name: 🌍 Start the Backend
        working-directory: backend
        run: |
          nohup npm start > backend.log 2>&1 &
          sleep 10  # Initial wait time

      - name: 🔍 Check Backend Health (Increased Retries)
        run: |
          for i in {1..20}; do  # Increased retries
            if curl -s http://localhost:3000/auth/login --fail; then
              echo "✅ Backend is responding"
              exit 0
            else
              echo "⏳ Backend not ready, retrying in 5s..."
              sleep 5
            fi
          done
          echo "❌ Backend did not start properly!" && exit 1

      - name: 🚀 Start Frontend
        working-directory: frontend
        run: |
          npm run build
          nohup npx vite preview --host 0.0.0.0 --port 5173 > frontend.log 2>&1 &
          sleep 10

      - name: 🔍 Debug API Before Testing
        run: |
          echo "🔍 Testing API Availability:"
          curl -s http://localhost:3000/auth/login || echo "⚠️ Login endpoint failed"
          curl -s http://localhost:3000/api/training-plan/1 || echo "⚠️ Training plan endpoint failed"
          curl -s http://localhost:3000/api/workouts || echo "⚠️ Workouts endpoint failed"

      - name: 🔍 Debug Logs Before Testing
        run: |
          echo "🔍 Backend logs:"
          cat backend/backend.log || echo "⚠️ No backend logs found"
          echo "🔍 Frontend logs:"
          cat frontend/frontend.log || echo "⚠️ No frontend logs found"
          echo "🌐 Checking network connections:"
          curl -s http://localhost:3000 || echo "⚠️ Backend not reachable"
          curl -s http://localhost:5173 || echo "⚠️ Frontend not reachable"

      - name: 🧪 Install Playwright Chromium Only
        run: npx playwright install chromium

      - name: 🔄 Run Playwright Tests (With Retries & Parallel)
        run: npx playwright test --workers=2 --retries=2

      - name: 📤 Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: 📤 Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            backend/backend.log
            frontend/frontend.log
          retention-days: 7
