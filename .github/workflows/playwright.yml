name: Playwright Tests

on:
  push:
    branches: [main, master, e2e-workout]
  pull_request:
    branches: [main, master, e2e-workout]

jobs:
  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd frontend && npm ci
          cd ../backend && npm ci && npm install --save-dev cross-env

      - name: ğŸ“„ Create .env file for Backend
        run: |
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" > backend/.env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> backend/.env
          echo "NODE_ENV=production" >> backend/.env

      - name: ğŸš€ Start Backend
        working-directory: backend
        run: |
          export NODE_ENV=production
          export PORT=3000
          nohup npm start > backend.log 2>&1 &
          sleep 10  # Warten, bis Backend startet

      - name: ğŸš€ Start Frontend
        working-directory: frontend
        run: |
          npm run build
          nohup npx vite preview --host 0.0.0.0 --port 5173 > frontend.log 2>&1 &
          sleep 10  # Warten, bis Frontend startet

      - name: ğŸ” Check Frontend & Backend
        run: |
          curl -Is http://localhost:3000/ | head -n 1 || echo "âš ï¸ Backend nicht erreichbar"
          curl -Is http://localhost:5173/ | head -n 1 || echo "âš ï¸ Frontend nicht erreichbar"

      - name: ğŸ§ª Install Playwright Chromium
        run: npx playwright install chromium

      - name: ğŸ”„ Run Playwright Tests
        run: |
          npx playwright test workout.spec.js --workers=2 --retries=1

      - name: ğŸ“¤ Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: ğŸ“¤ Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: |
            backend/backend.log
            frontend/frontend.log
          retention-days: 7
